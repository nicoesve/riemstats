---
title: "riemstats"
author: "Nicolas Escobar, Jaroslaw Harezlak"
date: "2025-02-12"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{riemstats}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The `riemstats` package provides specialized statistical methods for analyzing brain connectivity matrices (connectomes) from multi-site neuroimaging studies. When working with functional or structural connectivity data represented as symmetric positive definite (SPD) matrices, this package offers both harmonization techniques to address site-specific effects and ANOVA methods that respect the Riemannian geometry of SPD matrices.

## The Multi-Site Connectome Challenge

Modern neuroimaging studies often collect brain connectivity data across multiple sites to increase sample size and generalizability. However, this introduces significant challenges associated to the fact that different scanners, protocols, and populations introduce systematic biases.

Traditional statistical methods fail to address these challenges simultaneously, either ignoring the geometric structure of SPD matrices or lacking appropriate harmonization capabilities.

## Core Capabilities

`riemstats` addresses these challenges through two complementary sets of tools:

1. **Harmonization Methods**: Remove unwanted site/scanner effects while preserving biological signals
  - ComBat harmonization adapted for SPD matrices (see Honorro et al.)
  - Rigid geometric alignment methods (see Simeon et al.)

2. **ANOVA Methods**: Test for group differences while respecting SPD geometry
  - Fréchet ANOVA using Riemannian distances (see Muller et al.)
  - Riemannian ANOVA (closer to classical MANOVA, see Escobar, Harezlak.)
    - Wilks' lambda and Pillai's trace statistics on the tangent space  
    - Bootstrap inference for robust significance testing

By integrating harmonization and ANOVA within a Riemannian framework, `riemstats` enables rigorous statistical analysis of multi-site connectome data while preserving the geometric properties that make these matrices meaningful representations of brain connectivity.

## Typical Workflow

This section demonstrates a complete analysis pipeline for multi-site connectome data using `riemstats`. We'll walk through loading data, applying harmonization, and performing statistical tests.

### Loading the Package and Data

```{r load-package}
library(riemstats)

# Example: Load multi-site connectome data
# Assuming data is organized as a list of SPD matrices
# with associated site and group labels
data("example_connectomes")  # This would load example data

# Structure: 
# - connectomes: list of n x n SPD matrices
# - site_labels: vector indicating site/scanner for each subject
# - group_labels: vector indicating group membership (e.g., control vs patient)
```

### Data Harmonization

When working with multi-site data, harmonization is crucial to remove site-specific effects while preserving biological signals:

```{r harmonization}
# Apply ComBat harmonization for SPD matrices
harmonized_data <- combat_spd(
  matrices = connectomes,
  batch = site_labels,
  mod = model.matrix(~ group_labels)  # Preserve group differences
)

# Alternative: Rigid geometric alignment
aligned_data <- rigid_align_spd(
  matrices = connectomes,
  reference_site = 1  # Align all sites to site 1
)
```

### Statistical Analysis with Riemannian ANOVA

After harmonization, test for group differences using methods that respect the SPD geometry:

```{r anova-analysis}
# Fréchet ANOVA for overall group differences
frechet_result <- frechet_anova(
  matrices = harmonized_data,
  groups = group_labels,
  distance = "riemann"  # Use Riemannian distance
)

# Riemannian MANOVA with bootstrap inference
riemann_result <- riemann_manova(
  matrices = harmonized_data,
  groups = group_labels,
  test = "wilks",  # Or "pillai" for Pillai's trace
  n_bootstrap = 1000
)

# Display results
print(frechet_result)
print(riemann_result)
```

### Interpreting Results

The analysis provides several key outputs:

- **Test statistics**: Quantify the magnitude of group differences
- **P-values**: Assess statistical significance (adjusted for multiple comparisons when applicable)
- **Effect sizes**: Measure the practical importance of observed differences
- **Bootstrap confidence intervals**: Provide robust inference without parametric assumptions

